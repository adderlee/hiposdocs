{"name":"Hiposdocs","tagline":"HiPOS App 接口文档","body":"# HiPOS App 接口文档\r\n\r\n基于**OAuth2**对业务接口进行调用授权，回发数据统一为**JSON**格式，业务请求数据需要使用商户的**App Secret**签名。\r\n\r\n* [`基本API接口`](#基本API接口)\r\n* [`API接口签名规范`](#API接口签名规范)\r\n* [`业务API接口`](#业务API接口)\r\n* [`数据API接口`](#数据API接口)\r\n\r\n<a name=\"基本API接口\" />\r\n## 基本API接口\r\n调用业务接口前需要获得设备授权及AccessToken，本组接口向App提供这种能力。\r\n\r\n### 设备授权\r\n新安装 App 端的设备需要通过平台管理员的授权获得接口API接口的关键凭证。\r\n> 接口：/device/authorize（**提示：此接口调用时不需要OAuth2授权及签名**）\r\n\r\n调用参数：\r\n\r\n| 名称        | 类型        | 说明         | 示例                                 |\r\n| :---------- | :---------- | :----------- | :----------------------------------- |\r\n| auth_code   | string      | 授权码       |  12f8b2b9a74c4591a67a44b9ba0647e9    |\r\n| device_id   | string      | 设备唯一标识 |  3826ef14abfa52ca                    |\r\n| version     | string      | App版本      |  1.0.0.1                             |\r\n\r\n正确返回数据：\r\n```\r\n{\r\n  \"merchant_id\": \"1\",\r\n  \"merchant_name\": \"海商咖啡\",\r\n  \"merchant_logo\": \"http://him.hishop.com.cn:10800/assets/images/merchants/1.jpg\",\r\n  \"store_id\": \"5642e198a4826ee461311319\",\r\n  \"store_name\", \"大剧院旗舰店\",\r\n  \"app_id\": \"c4ca4238a0b923820dcc509a6f75849b\",\r\n  \"app_secret\": \"c40966e8f40a455425610606561819fa2a578c32\",\r\n  \"expires\": \"2016-11-11 23:59:59\",\r\n}\r\n```\r\n\r\n### 获取Access Token\r\n在正式调用业务接口前需要通过OAuth2获得**Access Token**，并且具有一定的有效期，再次调用业务接口前需要检查**Access Token**是否已经**过期**，否则需要重新获取。\r\n> 接口：/token\r\n\r\n调用参数：\r\n\r\nHTTP请求头中将 app_id 与 app_secret使用“:”拼接后使用**Base64**编码，使用**[HTTP基本认证](https://zh.wikipedia.org/wiki/HTTP%E5%9F%BA%E6%9C%AC%E8%AE%A4%E8%AF%81)**\r\n\r\n```\r\nAuthorization: Basic YzRjYTQyMzhhMGI5MjM4MjBkY2M1MDlhNmY3NTg0OWI6YzQwOTY2ZThmNDBhNDU1NDI1NjEwNjA2NTYxODE5ZmEyYTU3OGMzMg==\r\n```\r\n\r\n正确返回数据：\r\n```\r\n{\r\n  \"token_type\": \"bearer\",\r\n  \"access_token\": \"f7420dad8e471ab7df0f6b4b646f9010aea3e131\",\r\n  \"expires_in\": 3600\r\n}\r\n```\r\n<a name=\"API接口签名规范\" />\r\n## API接口签名规范\r\n原始业务数据如：\r\n>a=1&b=2&z=3\r\n\r\n加入随机时间码：\r\n>rnd=1447386720779\r\n\r\n按字母序形成待签名字符串：\r\n>a=1&b=2&rnd=1447386720779&z=3\r\n\r\n将\"sign=[App密钥]\"拼接到此字符串的最后面，形成：\r\n>a=1&b=2&rnd=1447386720779&z=3&sign=c40966e8f40a455425610606561819fa2a578c32\r\n\r\n将此字符串进行SHA1运算，得到签名：\r\n>sign = SHA1('a=1&b=2&rnd=1447386720779&z=3&sign=c40966e8f40a455425610606561819fa2a578c32')\r\n\r\n最后向接口POST的数据如下：\r\n>a=1&b=2&rnd=1447386720779&z=3&sign=cf81e8e0d756db9f0e301bf0b64d8525ef3edf85\r\n\r\n<a name=\"业务API接口\" />\r\n## 业务API接口\r\n完成与商户业务相关的API接口，如交易、结算等。\r\n>所有业务接口设调用时均需要提供 Bearer Token（即 Access Token）\r\n\r\n### 发起收款交易\r\n向平台发起收款交易，获得全平台唯一交易号。\r\n> 接口：/transaction/create\r\n\r\n调用参数：\r\n\r\n| 名称        | 类型        | 说明          | 示例                              |\r\n| :---------- | :---------- | :------------ | :-------------------------------- |\r\n| app_id      | string      | App ID        | c4ca4238a0b923820dcc509a6f75849b  |\r\n| merchant_id | string      | 商户ID        | 1                                 |\r\n| store_id    | string      | 门店ID        | 5642e198a4826ee461311319          |\r\n| device_id   | string      | 设备唯一标识  | 3826ef14abfa52ca                  |\r\n| job_id      | string      | 工号          | 1001                              |\r\n| amount      | number      | 金额          | 16.8                              |\r\n\r\n正确返回数据：\r\n```\r\n{\r\n  \"result\": {\r\n    \"__v\": 0,\r\n    \"_id\": \"8600000100000200000011\",\r\n    \"pay_expire\": \"2015-11-13T04:07:04.512Z\",\r\n    \"created_at\": \"2015-11-13T03:37:04.544Z\",\r\n    \"amount\": 0.01,\r\n    \"clerk_id\": \"5642e198a4826ee46131131a\",\r\n    \"store_id\": \"5642e198a4826ee461311319\",\r\n    \"stm_id\": \"86000001000002\"\r\n  }\r\n}\r\n```\r\n\r\n### 发起核销业务\r\n向平台发起二维码核销业务，获得全平台唯一交易号。\r\n> 接口：/transaction/qr\r\n\r\n调用参数：\r\n\r\n| 名称        | 类型        | 说明          | 示例                              |\r\n| :---------- | :---------- | :------------ | :-------------------------------- |\r\n| app_id      | string      | App ID        | c4ca4238a0b923820dcc509a6f75849b  |\r\n| merchant_id | string      | 商户ID        | 1                                 |\r\n| store_id    | string      | 门店ID        | 5642e198a4826ee461311319          |\r\n| device_id   | string      | 设备唯一标识  | 3826ef14abfa52ca                  |\r\n| job_id      | string      | 工号          | 1001                              |\r\n| code        | string      | 二维码文本    | YSC10011971                       |\r\n\r\n正确返回数据：\r\n```\r\n// 二维码无效\r\n{\r\n  \"error\": \"invalid code\"\r\n}\r\n\r\n// 不需要支付\r\n{\r\n  \"result\": \"ok\"\r\n}\r\n\r\n// 需要支付\r\n{\r\n  \"result\": {\r\n    \"__v\": 0,\r\n    \"_id\": \"8600000100000200000011\",\r\n    \"pay_expire\": \"2015-11-13T04:07:04.512Z\",\r\n    \"created_at\": \"2015-11-13T03:37:04.544Z\",\r\n    \"amount\": 0.01,\r\n    \"clerk_id\": \"5642e198a4826ee46131131a\",\r\n    \"store_id\": \"5642e198a4826ee461311319\",\r\n    \"stm_id\": \"86000001000002\"\r\n  }\r\n}\r\n```\r\n\r\n### 交班结算\r\n结算当前帐单\r\n> 接口：/transaction/settle\r\n\r\n调用参数：\r\n\r\n| 名称        | 类型        | 说明          | 示例                              |\r\n| :---------- | :---------- | :------------ | :-------------------------------- |\r\n| app_id      | string      | App ID        | c4ca4238a0b923820dcc509a6f75849b  |\r\n| store_id    | string      | 门店ID        | 5642e198a4826ee461311319          |\r\n| device_id   | string      | 设备唯一标识  | 3826ef14abfa52ca                  |\r\n| job_id      | string      | 工号          | 1001                              |\r\n\r\n正确返回数据：\r\n```\r\n{\r\n  \"result\": \"ok\"\r\n}\r\n```\r\n\r\n### 确认现金收款交易\r\n向平台确认正在进行中的现金收款交易，操作成功后，此交易即会关闭。\r\n> 接口：/transaction/confirm/cash\r\n\r\n调用参数：\r\n\r\n| 名称        | 类型        | 说明          | 示例                              |\r\n| :---------- | :---------- | :------------ | :-------------------------------- |\r\n| app_id      | string      | App ID        | c4ca4238a0b923820dcc509a6f75849b  |\r\n| tid         | string      | 交易号        | 8600000100001800000040            |\r\n\r\n正确返回数据：\r\n```\r\n{\r\n  \"result\": \"ok\"\r\n}\r\n```\r\n\r\n### 请求微信扫码支付\r\n生成微信扫码支付的二维条形码。\r\n> 接口：/transaction/weixin/qr/get\r\n\r\n调用参数：\r\n\r\n| 名称        | 类型        | 说明          | 示例                              |\r\n| :---------- | :---------- | :------------ | :-------------------------------- |\r\n| app_id      | string      | App ID        | c4ca4238a0b923820dcc509a6f75849b  |\r\n| tid         | string      | 交易号        | 8600000100001800000040            |\r\n\r\n正确返回数据：\r\n用于生成微信扫码付的二维码字符串。\r\n```\r\n{\r\n    \"result\": \"weixin://wxpay/bizpayurl?sign=FBA2E678AC50D9FEB6250413079FED43&appid=wx6f38b684087b31c2&mch_id=127764401&product_id=8600000100001800000092&time_stamp=1447406069&nonce_str=37sA8E\"\r\n}\r\n```\r\n\r\n### 微信刷卡支付\r\n扫描用户微信钱包中刷卡条码（二维码）完成微信支付交易。\r\n> 接口：/transaction/weixin/micropay\r\n\r\n调用参数：\r\n\r\n| 名称        | 类型        | 说明          | 示例                              |\r\n| :---------- | :---------- | :------------ | :-------------------------------- |\r\n| app_id      | string      | App ID        | c4ca4238a0b923820dcc509a6f75849b  |\r\n| tid         | string      | 交易号        | 8600000100001800000040            |\r\n| auth_code   | string      | 条码或二维码  | 120061098828009406                |\r\n\r\n正确返回数据：\r\n```\r\n{\r\n    \"result\": \"ok\"\r\n}\r\n```\r\n\r\n### 请求支付宝扫码支付\r\n将支付宝返回的二维码信息展示给用户，由用户扫描二维码完成订单支付。\r\n> 接口：/transaction/alipay/qr/get\r\n\r\n调用参数：\r\n\r\n| 名称        | 类型        | 说明          | 示例                              |\r\n| :---------- | :---------- | :------------ | :-------------------------------- |\r\n| app_id      | string      | App ID        | c4ca4238a0b923820dcc509a6f75849b  |\r\n| tid         | string      | 交易号        | 8600000100001800000040            |\r\n\r\n正确返回数据：\r\n用于生成支付宝扫码付的二维码字符串。\r\n```\r\n{\r\n    \"result\": \"https://qr.alipay.com/baxcwo4myomqqelrb4\"\r\n}\r\n```\r\n\r\n### 支付宝条码支付\r\n收银员使用扫码设备读取用户手机支付宝“付款码”后，将二维码或条码信息通过本接口上送至支付宝发起支付。\r\n> 接口：/transaction/alipay/barcode\r\n\r\n调用参数：\r\n\r\n| 名称        | 类型        | 说明          | 示例                              |\r\n| :---------- | :---------- | :------------ | :-------------------------------- |\r\n| app_id      | string      | App ID        | c4ca4238a0b923820dcc509a6f75849b  |\r\n| tid         | string      | 交易号        | 8600000100001800000040            |\r\n| auth_code   | string      | 条码或二维码  | 120061098828009406                |\r\n\r\n正确返回数据：\r\n```\r\n{\r\n    \"result\": \"ok\"\r\n}\r\n```\r\n\r\n<a name=\"数据API接口\" />\r\n## 数据API接口\r\n调用数据接口前需要获得设备授权及AccessToken。\r\n\r\n### 一日交易详情\r\n返回当日的所有收款通道（现金、微信、支付宝）的交易统计，包括交易金额和笔数。\r\n> 接口：/data/daily\r\n\r\n调用参数：\r\n\r\n| 名称        | 类型        | 说明          | 示例                              |\r\n| :---------- | :---------- | :------------ | :-------------------------------- |\r\n| app_id      | string      | App ID        | c4ca4238a0b923820dcc509a6f75849b  |\r\n| device_id   | string      | 设备唯一标识  | 3826ef14abfa52ca                  |\r\n| on          | string      | 交易日期      | 20151126                          |\r\n\r\n正确返回数据：\r\n```\r\n{\r\n    \"result\": {\r\n        \"items\": {\r\n            \"cash\": {\r\n                \"amount\": 5.7,\r\n                \"trades\": 10\r\n            },\r\n            \"alipay\": {\r\n                \"amount\": 12.05,\r\n                \"trades\": 50\r\n            },\r\n            \"weixin\": {\r\n                \"amount\": 82.25,\r\n                \"trades\": 40\r\n            }\r\n        },\r\n        \"total\": {\r\n            \"amount\": 100,\r\n            \"trades\": 100\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n### 一周交易详情\r\n返回当天起往前一周的的所有收款通道（现金、微信、支付宝）的交易统计，包括交易金额和笔数。\r\n> 接口：/data/weekly\r\n\r\n调用参数：\r\n\r\n| 名称        | 类型        | 说明          | 示例                              |\r\n| :---------- | :---------- | :------------ | :-------------------------------- |\r\n| app_id      | string      | App ID        | c4ca4238a0b923820dcc509a6f75849b  |\r\n| device_id   | string      | 设备唯一标识  | 3826ef14abfa52ca                  |\r\n| on          | string      | 交易日期      | 20151126                          |\r\n\r\n正确返回数据：\r\n```\r\n{\r\n    \"result\": {\r\n        \"amount\": {\r\n            \"cash\": [\r\n                102.5,\r\n                195.1,\r\n                140,\r\n                110.3,\r\n                208,\r\n                161,\r\n                164\r\n            ],\r\n            \"alipay\": [\r\n                700.5,\r\n                565.1,\r\n                580,\r\n                610.3,\r\n                804,\r\n                761,\r\n                828\r\n            ],\r\n            \"weixin\": [\r\n                630.5,\r\n                475.1,\r\n                420,\r\n                560.3,\r\n                704,\r\n                651,\r\n                681\r\n            ]\r\n        },\r\n        \"trades\": {\r\n            \"cash\": [\r\n                20,\r\n                23,\r\n                14,\r\n                19,\r\n                21,\r\n                16,\r\n                19\r\n            ],\r\n            \"alipay\": [\r\n                43,\r\n                56,\r\n                58,\r\n                61,\r\n                80,\r\n                76,\r\n                82\r\n            ],\r\n            \"weixin\": [\r\n                63,\r\n                47,\r\n                42,\r\n                56,\r\n                74,\r\n                61,\r\n                64\r\n            ]\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n### 帐单列表\r\n返回指定日期范围内的结算帐单列表，含金额与交易笔数及小计。\r\n> 接口：/data/bill/list\r\n\r\n调用参数：\r\n\r\n| 名称        | 类型        | 说明          | 示例                              |\r\n| :---------- | :---------- | :------------ | :-------------------------------- |\r\n| app_id      | string      | App ID        | c4ca4238a0b923820dcc509a6f75849b  |\r\n| device_id   | string      | 设备唯一标识  | 3826ef14abfa52ca                  |\r\n| from        | string      | 起始日期      | 20151101                          |\r\n| to          | string      | 截止日期      | 20151130                          |\r\n\r\n正确返回数据：\r\n```\r\n{\r\n    \"result\": [\r\n        {\r\n            \"on\": \"2015-11-23\",\r\n            \"amount\": 651.5,\r\n            \"trades\": 143,\r\n            \"settlements\": [\r\n                {\r\n                    \"stm_id\": \"86000001000001\",\r\n                    \"created_at\": \"2015-11-23 08:03:49\",\r\n                    \"settled_at\": \"2015-11-23 11:58:30\",\r\n                    \"amount\": 123.5,\r\n                    \"trades\": 21\r\n                },\r\n                {\r\n                    \"stm_id\": \"86000001000002\",\r\n                    \"created_at\": \"2015-11-23 11:59:00\",\r\n                    \"settled_at\": \"2015-11-23 15:58:30\",\r\n                    \"amount\": 160.9,\r\n                    \"trades\": 35\r\n                },\r\n                {\r\n                    \"stm_id\": \"86000001000003\",\r\n                    \"created_at\": \"2015-11-23 15:59:00\",\r\n                    \"settled_at\": \"2015-11-23 22:58:30\",\r\n                    \"amount\": 367.1,\r\n                    \"trades\": 87\r\n                }\r\n            ]\r\n        },\r\n        {\r\n            \"on\": \"2015-11-24\",\r\n            \"amount\": 651.5,\r\n            \"trades\": 143,\r\n            \"settlements\": [\r\n                {\r\n                    \"stm_id\": \"86000001000001\",\r\n                    \"created_at\": \"2015-11-24 08:03:49\",\r\n                    \"settled_at\": \"2015-11-24 11:58:30\",\r\n                    \"amount\": 123.5,\r\n                    \"trades\": 21\r\n                },\r\n                {\r\n                    \"stm_id\": \"86000001000002\",\r\n                    \"created_at\": \"2015-11-24 11:59:00\",\r\n                    \"settled_at\": \"2015-11-24 15:58:30\",\r\n                    \"amount\": 160.9,\r\n                    \"trades\": 35\r\n                },\r\n                {\r\n                    \"stm_id\": \"86000001000002\",\r\n                    \"created_at\": \"2015-11-24 15:59:00\",\r\n                    \"settled_at\": \"2015-11-24 22:58:30\",\r\n                    \"amount\": 367.1,\r\n                    \"trades\": 87\r\n                }\r\n            ]\r\n        },\r\n        {\r\n            \"on\": \"2015-11-25\",\r\n            \"amount\": 651.5,\r\n            \"trades\": 143,\r\n            \"settlements\": [\r\n                {\r\n                    \"stm_id\": \"86000001000003\",\r\n                    \"created_at\": \"2015-11-25 08:03:49\",\r\n                    \"settled_at\": \"2015-11-25 11:58:30\",\r\n                    \"amount\": 123.5,\r\n                    \"trades\": 21\r\n                },\r\n                {\r\n                    \"stm_id\": \"86000001000002\",\r\n                    \"created_at\": \"2015-11-25 11:59:00\",\r\n                    \"settled_at\": \"2015-11-25 15:58:30\",\r\n                    \"amount\": 160.9,\r\n                    \"trades\": 35\r\n                },\r\n                {\r\n                    \"stm_id\": \"86000001000003\",\r\n                    \"created_at\": \"2015-11-25 15:59:00\",\r\n                    \"settled_at\": \"2015-11-25 22:58:30\",\r\n                    \"amount\": 367.1,\r\n                    \"trades\": 87\r\n                }\r\n            ]\r\n        }\r\n    ]\r\n}\r\n```\r\n\r\n### 帐单明细\r\n返回指定结算帐单及相关交易详情信息。\r\n> 接口：/data/bill/detail\r\n\r\n调用参数：\r\n\r\n| 名称        | 类型        | 说明          | 示例                              |\r\n| :---------- | :---------- | :------------ | :-------------------------------- |\r\n| app_id      | string      | App ID        | c4ca4238a0b923820dcc509a6f75849b  |\r\n| device_id   | string      | 设备唯一标识  | 3826ef14abfa52ca                  |\r\n| stm_id      | string      | 结算帐单ID    | 86000001000003                    |\r\n\r\n正确返回数据：\r\n```\r\n{\r\n    \"result\": {\r\n        \"stm_id\": \"86000001000002\",\r\n        \"created_at\": \"2015-11-25 15:59:00\",\r\n        \"settled_at\": \"2015-11-25 22:58:30\",\r\n        \"amount\": 0.18,\r\n        \"trades\": 3,\r\n        \"total\": {\r\n            \"cash\": {\r\n                \"amount\": 0.12,\r\n                \"trades\": 1\r\n            },\r\n            \"weixin\": {\r\n                \"amount\": 0.01,\r\n                \"trades\": 1\r\n            },\r\n            \"alipay\": {\r\n                \"amount\": 0.05,\r\n                \"trades\": 1\r\n            }\r\n        }\r\n        \"transactions\": [\r\n            {\r\n                \"tid\": \"8600000100000100000009\",\r\n                \"paid_at\": \"2015-11-25 22:58:30\",\r\n                \"amount\": 121.5,\r\n                \"method\": \"weixin\"\r\n            },\r\n            {\r\n                \"tid\": \"8600000100000100000010\",\r\n                \"paid_at\": \"2015-11-25 23:01:12\",\r\n                \"amount\": 98.6,\r\n                \"method\": \"alipay\"\r\n            },\r\n            {\r\n                \"tid\": \"8600000100000100000011\",\r\n                \"paid_at\": \"2015-11-25 23:11:34\",\r\n                \"amount\": 147,\r\n                \"method\": \"cash\"\r\n            }\r\n        ]\r\n    }\r\n}\r\n```\r\n\r\n### 当前帐单明细\r\n返回当前正在进行中结算帐单及相关交易详情信息。\r\n> 接口：/data/bill/current\r\n\r\n调用参数：\r\n\r\n| 名称        | 类型        | 说明          | 示例                              |\r\n| :---------- | :---------- | :------------ | :-------------------------------- |\r\n| app_id      | string      | App ID        | c4ca4238a0b923820dcc509a6f75849b  |\r\n| store_id    | string      | 门店ID        | 5642e198a4826ee461311319          |\r\n| device_id   | string      | 设备唯一标识  | 3826ef14abfa52ca                  |\r\n| job_id      | string      | 工号          | 1001                              |\r\n\r\n正确返回数据：\r\n```\r\n{\r\n    \"result\": {\r\n        \"stm_id\": \"86000001000002\",\r\n        \"created_at\": \"2015-11-25 15:59:00\",\r\n        \"settled_at\": \"2015-11-25 22:58:30\",\r\n        \"amount\": 0.18,\r\n        \"trades\": 3,\r\n        \"total\": {\r\n            \"cash\": {\r\n                \"amount\": 0.12,\r\n                \"trades\": 1\r\n            },\r\n            \"weixin\": {\r\n                \"amount\": 0.01,\r\n                \"trades\": 1\r\n            },\r\n            \"alipay\": {\r\n                \"amount\": 0.05,\r\n                \"trades\": 1\r\n            }\r\n        }\r\n        \"transactions\": [\r\n            {\r\n                \"tid\": \"8600000100000100000009\",\r\n                \"paid_at\": \"2015-11-25 22:58:30\",\r\n                \"amount\": 121.5,\r\n                \"method\": \"weixin\"\r\n            },\r\n            {\r\n                \"tid\": \"8600000100000100000010\",\r\n                \"paid_at\": \"2015-11-25 23:01:12\",\r\n                \"amount\": 98.6,\r\n                \"method\": \"alipay\"\r\n            },\r\n            {\r\n                \"tid\": \"8600000100000100000011\",\r\n                \"paid_at\": \"2015-11-25 23:11:34\",\r\n                \"amount\": 147,\r\n                \"method\": \"cash\"\r\n            }\r\n        ]\r\n    }\r\n}\r\n```\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}